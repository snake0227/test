<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>定期テスト対策</title>
    <style>
        body { font-family: sans-serif; text-align: center; background-color: #f0f2f5; margin: 0; padding: 10px; }
        .card { 
            background: white; padding: 15px; border-radius: 15px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-width: 500px; 
            margin: auto; display: flex; flex-direction: column; align-items: center; 
        }
        canvas {
            border: 2px solid #333; background-color: #fff; touch-action: none;
            cursor: crosshair; border-radius: 8px; margin: 10px 0;
            width: 100%; max-width: 320px; height: 200px;
        }
        button {
            width: 100%; max-width: 400px; height: 50px; margin: 5px auto;
            cursor: pointer; font-size: 16px; border-radius: 10px; border: 1px solid #ddd;
            display: block; font-weight: bold;
        }
        .choice-btn, .check-btn { background-color: #007bff; color: white; border: none; }
        .correct-btn { background-color: #28a745; color: white; border: none; }
        .incorrect-btn { background-color: #dc3545; color: white; border: none; }
        .clear-btn { background-color: #6c757d; color: white; border: none; width: 45%; display: inline-block; }
        #answer_zone { display: none; width: 100%; background: #f8f9fa; padding: 15px; border-radius: 10px; box-sizing: border-box; }
        /* 答えが長い場合を考慮してサイズを少し調整 */
        .ans-text { font-size: 1.3rem; color: #d63384; font-weight: bold; margin: 10px 0; word-break: break-all; }
        #question { font-size: 1.1rem; font-weight: bold; min-height: 2.5em; color: #444; }
        .status { font-size: 0.8rem; color: #777; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="card">
        <h1>定期テスト対策</h1>
        <p id="displaysubject">教科を選択してください</p>
        
        <div id="menu_area">
            <button class="choice-btn" onclick="changesubject('bio_base')">生物基礎</button>
            <button class="choice-btn" onclick="changesubject('history')">歴史</button>
        </div>

        <div id="quiz_area" style="display: none;">
            <p class="status" id="q_status"></p>
            <p id="question"></p>
            
            <canvas id="write_canvas" width="320" height="200"></canvas>
            
            <div style="width: 100%; display: flex; justify-content: space-between; max-width: 320px;">
                <button type="button" class="clear-btn" onclick="clearCanvas()">消去</button>
                <button type="button" id="show_ans_btn" class="check-btn" style="width: 50%;" onclick="showAnswer()">答えを見る</button>
            </div>

            <div id="answer_zone">
                <p style="margin:0;">正解：</p>
                <p class="ans-text" id="correct_answer"></p>
                <div style="display: flex; gap: 10px;">
                    <button class="correct-btn" onclick="processResult(true)">書けた</button>
                    <button class="incorrect-btn" onclick="processResult(false)">ダメだ</button>
                </div>
            </div>
            <button onclick="backToMenu()" style="border:none; background:none; color:blue; text-decoration:underline; margin-top:10px;">中断して戻る</button>
        </div>
    </div>

    <script>
        const initialData = {
            'bio_base': [
                { id: 'b1', q: '病原体等の異物から体を守る仕組みは？', a: '免疫' },
                { id: 'b2', q: '病原体等の異物に対応する細胞はなに？', a: '免疫機能' },
                { id: 'b3', q: '免疫に重要な働きをしているものはなに？', a: '白血球' },
                { id: 'b4', q: '白血球の約60%を占めるののは？', a: '好中球' },
                { id: 'b5', q: '侵入してきた病原体に対して即座に働く免疫を何という？', a: '自然免疫' },
                { id: 'b6', q: '自然免疫に関与する白血球の成分を三種類答えよ', a: '好中球、マクロファージ、樹状細胞' },
                { id: 'b7', q: '自然免疫において、病原体等の異物を取り込む働きをなんという？', a: '食作用' },
                { id: 'b8', q: '食作用を持つ細胞はなに？', a: '食細胞' },
                { id: 'b9', q: '自然免疫だけでは対処できない病原体や毒素を異物として認識し、排除する仕組みはなに？', a: '適応免疫' },
                { id: 'b10', q: '適応免疫にかかわる主な細胞を２つ答えよ。', a: 'B細胞、T細胞' },
                { id: 'b11', q: 'B細胞やT細胞によって異物として認識される物質をなんという？', a: '抗原' },
                { id: 'b12', q: '適応免疫は仕組みの違いから何と何にわけられる？', a: '体液性免疫、細胞性免疫' },
                { id: 'b13', q: '体液性免疫は、何によって病原体等の抗原を排除する仕組み？', a: '抗体' },
                { id: 'b14', q: '抗体が抗原を認識して、特異的に結合する反応をなんという？', a: '抗原抗体反応' },
                { id: 'b15', q: '抗体はなにによって分泌される？', a: '形質細胞（抗体産生細胞）' },
                { id: 'b16', q: '形質細胞は何が増殖し、分化したもの？', a: 'B細胞' },
                { id: 'b17', q: '細胞に入り込んだウイルス等の抗体で排除することの出来ない異物を、細胞事排除する仕組みをなんという？', a: '細胞性免疫' },
                { id: 'b18', q: '細胞性免疫において感染した細胞ごと排除するのはなんという細胞？', a: 'キラーT細胞' },
                { id: 'b19', q: '抗原提示を行い、キラーT細胞を活性化・増殖を行う細胞を２つ答えよ。', a: '樹状細胞、ヘルパーT細胞' },
                { id: 'b20', q: '血管が傷つくと、集まって傷をふさぐのはなに？', a: '血小板' },
                { id: 'b21', q: '血小板から放出される血小板因子によって形成される、水に溶けにくい繊維状のタンパク質はなに？', a: 'フィブリン' },
                { id: 'b22', q: 'フィブリンが血球と絡み合うことで作られるのはなに？', a:'血ぺい' },
                { id: 'b23', q: '血管が傷ついた時に血ぺいを作り、体液の流出を防ぎ、体液を保持する一連の過程をなんというか？', a: '血液凝固' },
                { id: 'b24', q: 'ある病原体にはじめて感染した時の免疫応答をなんという？', a: '一次応答'},
                { id: 'b25', q: '２回目以降に同じ病原体に感染した時の免疫応答をなんという？', a: '二次応答'},
                { id: 'b26', q: '一次応答で活性化したB細胞やT細胞の一部が体内に残ったものをなんという？', a: '記憶細胞' },
                { id: 'b27', q: '一度感染した病原体に再度感染した時に、初回よりも速く病原体を攻撃する仕組みをなんという？', a: '免疫記憶' },
                { id: 'b28', q: '抗体は、なんというタンパク質か？', a: '免疫グロブリン' },
                { id: 'b29', q: '免疫細胞の仕組みを利用し、感染症を予防する方法をなんという？', a: '予防接種' },
                { id: 'b30', q: '弱毒化、無毒化した抗原をなんという？', a: 'ワクチン' },
                { id: 'b31', q: '本来は免疫が働く必要がない非自己物質に対して過敏に免疫が働いてしまうことをなんという？', a: 'アレルギー' },
                { id: 'b32', q: 'アレルギーの原因となる抗原はなんという？', a: 'アレルゲン' },
                { id: 'b33', q: '生命が脅かされるような重症なアレルギー症状をなんという？', a: 'アナフィラキシー' },
                { id: 'b34', q: '自分自身の正常な細胞や組織に対して攻撃してしまう疾患をなんという？', a: '自己免疫疾患' },
                { id: 'b35', q: 'AIDSとはどのような病気か？以下の語句をすべて用いて説明せよ[HIV,ヘルパーT細胞,体液性免疫,細胞性免疫]', a: 'HIVがヘルパーT細胞の機能を停止させ、体液性免疫と細胞性免疫の両方が働かなくなってしまう病気' }
            ],
            'history': [
                { id: 'h1', q: '朝鮮戦争が始まり、日本で警察予備隊が設置されたのは西暦何年？', a: '1950年' }
            ]
        };

        let userLevels = JSON.parse(localStorage.getItem('userLevels')) || {};
        let currentSubject = "";
        let masterList = [];
        let currentIdxInList = 0;

        const canvas = document.getElementById('write_canvas');
        const ctx = canvas.getContext('2d');
        let drawing = false;

        function setupCanvas() {
            ctx.lineWidth = 3; ctx.lineCap = 'round'; ctx.strokeStyle = '#000';
            const getPos = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.clientX || (e.touches ? e.touches[0].clientX : 0);
                const clientY = e.clientY || (e.touches ? e.touches[0].clientY : 0);
                return { x: clientX - rect.left, y: clientY - rect.top };
            };
            const startDraw = (e) => { drawing = true; ctx.beginPath(); const pos = getPos(e); ctx.moveTo(pos.x, pos.y); };
            const draw = (e) => { if (!drawing) return; const pos = getPos(e); ctx.lineTo(pos.x, pos.y); ctx.stroke(); };
            const endDraw = () => { drawing = false; };
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            window.addEventListener('mouseup', endDraw);
            canvas.addEventListener('touchstart', startDraw, {passive: false});
            canvas.addEventListener('touchmove', (e) => { e.preventDefault(); draw(e); }, {passive: false});
            canvas.addEventListener('touchend', endDraw);
        }

        function clearCanvas() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

        function changesubject(name) {
            currentSubject = name;
            document.getElementById('menu_area').style.display = 'none';
            document.getElementById('quiz_area').style.display = 'block';
            document.getElementById('displaysubject').innerText = name === 'bio_base' ? '【生物基礎】' : '【歴史】';
            masterList = [...initialData[name]].sort((a, b) => (userLevels[a.id] || 0) - (userLevels[b.id] || 0));
            currentIdxInList = 0;
            setupCanvas();
            renderQuestion();
        }

        function renderQuestion() {
            if (currentIdxInList >= masterList.length) {
                currentIdxInList = 0;
                masterList.sort((a, b) => (userLevels[a.id] || 0) - (userLevels[b.id] || 0));
            }
            const qObj = masterList[currentIdxInList];
            const lv = userLevels[qObj.id] || 0;
            document.getElementById('q_status').innerText = `習得度レベル: ${lv}`;
            document.getElementById('question').innerText = qObj.q;
            clearCanvas();
            document.getElementById('answer_zone').style.display = 'none';
            document.getElementById('show_ans_btn').style.display = 'block';
        }

        function showAnswer() {
            document.getElementById('answer_zone').style.display = 'block';
            document.getElementById('correct_answer').innerText = masterList[currentIdxInList].a;
            document.getElementById('show_ans_btn').style.display = 'none';
        }

        function processResult(isCorrect) {
            const qId = masterList[currentIdxInList].id;
            if (isCorrect) {
                userLevels[qId] = (userLevels[qId] || 0) + 1;
            } else {
                userLevels[qId] = 0;
            }
            localStorage.setItem('userLevels', JSON.stringify(userLevels));
            currentIdxInList++;
            renderQuestion();
        }

        function backToMenu() {
            document.getElementById('menu_area').style.display = 'block';
            document.getElementById('quiz_area').style.display = 'none';
            document.getElementById('displaysubject').innerText = '教科を選択してください';
        }
    </script>
</body>
</html>
